name: ğŸ“¥ Gesamtworkflow Spielplan2526

on:
  workflow_dispatch:
  schedule:
    # Wochenende (Samstag=6, Sonntag=0): stÃ¼ndlich
    - cron: '0 * * * 6,0'
    # Wochentage (Montagâ€“Freitag): alle 6 Stunden
    - cron: '0 */6 * * 1-5'

# verhindert Ã¼berlappende LÃ¤ufe
concurrency:
  group: pipeline
  cancel-in-progress: true

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # BLOCK 1: ICS herunterladen
      # =========================
      - name: ğŸ“¥ Repository klonen (mit Schreibzugriff)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: ğŸ§¹ Ordner csv_Baskets leeren
        run: |
          mkdir -p csv_Baskets
          rm -f csv_Baskets/*

      - name: ğŸŒ Baskets-Kalender (ICS) herunterladen
        run: curl -L "https://api.2basketballbundesliga.de/cal/562" -o csv_Baskets/Baskets_2526.ics

      - name: ğŸŒ PreuÃŸen MÃ¼nster-Kalender (ICS) herunterladen
        run: |
          curl -L "http://i.cal.to/ical/7477/bundesliga/sc-preussen-muenster/7dc6da48.a8ea1dd5-20526fdc.ics" \
            -o csv_Baskets/Preussen_2526.ics || echo "âš ï¸ PreuÃŸen-ICS nicht erreichbar"

      - name: ğŸ” Commit & Push ICS
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add csv_Baskets
          git commit -m "ğŸ“¥ ICS-Dateien aktualisiert" || echo "nichts zu committen"
          git pull --rebase
          git push

      - name: â±ï¸ Pause nach ICS
        run: sleep 30

      # =========================
      # Python Setup
      # =========================
      - name: ğŸ Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ AbhÃ¤ngigkeiten installieren
        run: pip install pandas pytz

      # ===========================================
      # BLOCK 2: Volleyball-CSV herunterladen
      # ===========================================
      - name: ğŸ“ Verzeichnis csvdata vorbereiten
        run: |
          mkdir -p csvdata
          rm -f csvdata/*

      - name: ğŸŒ Volleyball-SpielplÃ¤ne herunterladen & vereinheitlichen
        run: |
          set -e
          shopt -s nullglob
          cd csvdata

          download_csv () {
            local url="$1"
            local pattern="$2"
            local target="$3"

            echo "â¬‡ï¸ Download: $target"
            curl -L -OJ "$url"

            files=($pattern)
            if [ ${#files[@]} -gt 0 ]; then
              latest="$(ls -t "${files[@]}" | head -n 1)"
              mv "$latest" "$target"
              echo "âœ… $latest â†’ $target"
              return
            fi

            if [ -f "PlayingScheduleCsvExport" ]; then
              mv "PlayingScheduleCsvExport" "$target"
              echo "âœ… PlayingScheduleCsvExport â†’ $target"
              return
            fi

            echo "âŒ FEHLER: Keine passende CSV fÃ¼r $target"
            ls -la
            exit 1
          }

          # ---------- NRW ----------
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95239897" "Spielplan_Bezirksliga_14_Frauen_*.csv" "Spielplan_Bezirksliga_14_Frauen.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95244340" "Spielplan_Oberliga_2_Frauen_*.csv" "Spielplan_Oberliga_2_Frauen.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95243632" "Spielplan_Bezirksklasse_26_Frauen_*.csv" "Spielplan_Bezirksklasse_26_Frauen.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95245637" "Spielplan_NRW-Liga_wU16_*.csv" "Spielplan_NRW-Liga_wU16.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95245654" "Spielplan_Oberliga_5_wU16_*.csv" "Spielplan_Oberliga_5_wU16.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95251101" "Spielplan_NRW-Liga_wU14_*.csv" "Spielplan_NRW-Liga_wU14.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95251080" "Spielplan_Oberliga_5_wU14_*.csv" "Spielplan_Oberliga_5_wU14.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95250874" "Spielplan_NRW-Liga_wU18_*.csv" "Spielplan_NRW-Liga_wU18.csv"
          download_csv "https://ergebnisdienst.volleyball.nrw/servlet/league/PlayingScheduleCsvExport?matchSeriesId=95241488" "Spielplan_Kreisliga_Muenster_Frauen_*.csv" "Spielplan_Kreisliga_Muenster_Frauen.csv"

          # ---------- Bundesliga ----------
          download_csv "https://www.volleyball-bundesliga.de/servlet/league/PlayingScheduleCsvExport?matchSeriesId=776311171" "Spielplan_1._Bundesliga_Frauen_*.csv" "Spielplan_1._Bundesliga_Frauen.csv"
          download_csv "https://www.volleyball-bundesliga.de/servlet/league/PlayingScheduleCsvExport?matchSeriesId=776309163" "Spielplan_2._Bundesliga_Frauen_Nord_*.csv" "Spielplan_2._Bundesliga_Frauen_Nord.csv"

          shopt -u nullglob
          echo "ğŸ“‚ csvdata Inhalt:"
          ls -la

      - name: ğŸ” Commit & Push CSV
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add csvdata
          git commit -m "ğŸ“Š Volleyball-SpielplÃ¤ne aktualisiert" || echo "nichts zu committen"
          git pull --rebase
          git push

      - name: â±ï¸ Pause nach CSV
        run: sleep 30

      # =================================
      # BLOCK 3: Baskets CSV aus ICS
      # =================================
      - name: ğŸ›  Baskets CSV erzeugen
        run: python baskets_csv.py

      - name: ğŸ” Commit & Push Baskets CSV
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add csv_Baskets/Baskets_2526_Heimspiele.csv
          git commit -m "ğŸ€ Baskets CSV aktualisiert" || echo "nichts zu committen"
          git pull --rebase
          git push

      - name: â±ï¸ Pause
        run: sleep 30

      # =================================
      # BLOCK 4: PreuÃŸen CSV aus ICS
      # =================================
      - name: ğŸ›  PreuÃŸen CSV erzeugen
        run: python preussen_csv.py

      - name: ğŸ” Commit & Push PreuÃŸen CSV
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add csv_Baskets/Preussen_2526_Heimspiele.csv
          git commit -m "âš½ PreuÃŸen CSV aktualisiert" || echo "nichts zu committen"
          git pull --rebase
          git push

      - name: â±ï¸ Pause
        run: sleep 30

      # =====================================
      # BLOCK 5: HTML & ICS generieren
      # =====================================
      - name: ğŸ›  HTML & ICS generieren
        run: |
          python usc_baskets_preussen.py
          python usc_spielplan.py
          python usc_spielplan_ics.py

      - name: ğŸ” Commit & Push HTML
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add docs/
          git commit -m "ğŸ“… Spielplan HTML & ICS aktualisiert" || echo "nichts zu committen"
          git pull --rebase
          git push
